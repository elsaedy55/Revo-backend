# دليل اختبار API التاريخ الطبي

## المتطلبات الأساسية

### 1. تشغيل السيرفر
```bash
npm run dev
```

### 2. التحقق من قاعدة البيانات
- تأكد من تشغيل PostgreSQL
- تأكد من تنفيذ جميع ملفات الترحيل (migrations)

### 3. المصادقة
- يجب الحصول على توكن JWT صالح من خلال تسجيل الدخول
- مدة صلاحية التوكن 24 ساعة

## حدود البيانات والتحقق

### القيود على الحقول
- **condition_name**: 
  - مطلوب
  - الحد الأدنى: 2 حرف
  - الحد الأقصى: 255 حرف

- **diagnosis_date**:
  - اختياري
  - يجب أن يكون تاريخاً صالحاً
  - لا يمكن أن يكون في المستقبل
  - الصيغة: YYYY-MM-DD

- **treatment_description**:
  - اختياري
  - الحد الأقصى: 1000 حرف

- **medications**:
  - اختياري
  - الحد الأقصى: 1000 حرف

- **surgery_history**:
  - اختياري
  - الحد الأقصى: 1000 حرف

- **allergies**:
  - اختياري
  - الحد الأقصى: 500 حرف

- **chronic_diseases**:
  - اختياري
  - الحد الأقصى: 500 حرف

- **notes**:
  - اختياري
  - الحد الأقصى: 1000 حرف

## نقاط النهاية (Endpoints)

### 1. إنشاء سجل طبي جديد

**طلب**:
- **الطريقة**: POST
- **المسار**: `http://localhost:3000/api/medical-history`
- **الهيدرز**:
  ```
  Authorization: Bearer {your-jwt-token}
  Content-Type: application/json
  ```
- **البيانات**:
  ```json
  {
    "condition_name": "حساسية موسمية",
    "diagnosis_date": "2024-03-15",
    "treatment_description": "مضادات الهيستامين",
    "medications": "كلاريتين، سيتريزين",
    "surgery_history": "لا يوجد",
    "allergies": "حساسية من غبار الطلع",
    "chronic_diseases": "لا يوجد",
    "notes": "تظهر الأعراض في فصل الربيع"
  }
  ```

**استجابات**:
- نجاح (201 Created):
  ```json
  {
    "نجاح": true,
    "رسالة": "تم حفظ السجل الطبي بنجاح",
    "بيانات": {
      "id": 1,
      "condition_name": "حساسية موسمية",
      "created_at": "2024-03-15T12:00:00Z",
      // ... باقي البيانات
    }
  }
  ```
- خطأ في التحقق (400 Bad Request):
  ```json
  {
    "نجاح": false,
    "أخطاء": [
      {
        "حقل": "condition_name",
        "رسالة": "يجب إدخال اسم الحالة المرضية"
      }
    ]
  }
  ```

### 2. عرض السجلات الطبية

**طلب**:
- **الطريقة**: GET
- **المسار**: `http://localhost:3000/api/medical-history`
- **الهيدرز**:
  ```
  Authorization: Bearer {your-jwt-token}
  ```

**استجابات**:
- نجاح (200 OK):
  ```json
  {
    "نجاح": true,
    "بيانات": [
      {
        "id": 1,
        "condition_name": "حساسية موسمية",
        // ... باقي البيانات
      }
    ]
  }
  ```

### 3. تحديث سجل طبي

**طلب**:
- **الطريقة**: PUT
- **المسار**: `http://localhost:3000/api/medical-history/{id}`
- **الهيدرز**:
  ```
  Authorization: Bearer {your-jwt-token}
  Content-Type: application/json
  ```
- **البيانات**: نفس بنية الإنشاء

**استجابات**:
- نجاح (200 OK):
  ```json
  {
    "نجاح": true,
    "رسالة": "تم تحديث السجل الطبي بنجاح",
    "بيانات": {
      "id": 1,
      "updated_at": "2024-03-15T14:30:00Z",
      // ... البيانات المحدثة
    }
  }
  ```
- سجل غير موجود (404 Not Found):
  ```json
  {
    "نجاح": false,
    "رسالة": "لم يتم العثور على السجل الطبي"
  }
  ```

## أخطاء المصادقة

### 1. توكن غير صالح (401 Unauthorized)
```json
{
  "نجاح": false,
  "رسالة": "غير مصرح به!"
}
```

### 2. هيدر المصادقة مفقود (403 Forbidden)
```json
{
  "نجاح": false,
  "رسالة": "لم يتم توفير هيدر Authorization",
  "required": "Authorization: Bearer <token>"
}
```

## أفضل الممارسات للاختبار

1. **التحقق من المصادقة**:
   - استخدم توكن صالح وغير منتهي الصلاحية
   - تأكد من إرسال التوكن في الهيدر بالصيغة الصحيحة

2. **التحقق من البيانات**:
   - اختبر الحدود القصوى للحقول النصية
   - جرب إرسال تواريخ مستقبلية للتأكد من رفضها
   - اختبر السلوك مع الحقول الفارغة والقيم null

3. **اختبار الأخطاء**:
   - جرب تحديث سجل غير موجود
   - أرسل بيانات غير صالحة للتحقق من رسائل الخطأ
   - اختبر السلوك مع توكن منتهي الصلاحية

4. **التحقق من الاستجابات**:
   - تأكد من رموز الحالة (status codes) الصحيحة
   - تحقق من تنسيق البيانات في الاستجابة
   - تأكد من وجود جميع الحقول المتوقعة